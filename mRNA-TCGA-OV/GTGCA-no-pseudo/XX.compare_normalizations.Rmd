---
title: "zz"
author: "Ieva"
date: "2023-08-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#setwd to wsl tcga data!
library(tidyverse)
library(GDCRNATools)
library(dendextend)
```
```{r}
#isikelsiu genus tcga/gtex data be keistu genu visokiu
setwd("//wsl.localhost/Ubuntu-18.04/home/ieva/rprojects/TCGA-OV-data")
counts_gtcga <- readRDS("filtered_gtgca_counts.RDS") 
coldata_gtcga <- readRDS("coldata_gtcga_full.RDS")
```
## No.1: GDCRNAtools
```{r}
dim(counts_gtcga) #10925   601
#1 type 2: from GDCRNAtools: gdcVoomNormalization: does TNB ir voom transformatio
mRNA_voom <- gdcVoomNormalization(counts = counts_gtcga, filter = TRUE) #
#pridedam normal vardus
mRNA_voomt <- t(mRNA_voom)
dim(mRNA_voomt) #  lieka su filtru 601 2684
```
plot no.1
```{r}
htree_norm <- hclust(dist(mRNA_voomt), method = "average") #can take some time
dend3 <- as.dendrogram(htree_norm)
col_aa_red <- ifelse(grepl("GTEX", labels(dend3)), "red", "blue")
dend4 <- assign_values_to_leaves_edgePar(dend=dend3, value = col_aa_red, edgePar = "col") 
pdf(file="figures/htree_no_pseudo_gtex_tcga_norm_red.pdf", height=80, width=100) #issaugijimui didesniu formatu
plot(dend4) #dstant samples should be excluded #save portrait 20x66 inch pdf
dev.off()
```

##NO.2 PVZ is XENA
```{r}
#2 normalization - is XENA tutorialo, turetu buti tas pats voom
x = DGEList(counts_gtcga)

snames = colnames(x);
group = substr(snames, 1, 4); #Sets up level information for samples.
x$samples$group = group #Assigns samples to appropriate group.
```
```{r}
cpm = cpm(x);
lcpm = cpm(x, log = TRUE);
L = mean(x$samples$lib.size) * 1e-6;
L #Displays average library size in millions.

M = median(x$samples$lib.size) * 1e-6;
M #Displays median library size in millions.

table(x$samples$group) #Returns number of samples per group.
```
Determine which genes have sufficiently large counts to be retained in subsequent statistical analysis
```{r}
keep.exprs = filterByExpr(x, group = group);
x = x[keep.exprs, , keep.lib.sizes = FALSE];
dim(x) #Returns number of genes and samples retained.
```
buvo: 601 10925
liko: 601 3435  

Generate density plot of log-CPM values for QC.
```{r}
lcpm.cutoff = log2(10/M + 2/L);
nsamples = ncol(x);
par(mfrow=c(1, 2));
plot(density(lcpm[, 1]), lwd = 2, ylim = c(0, 0.26), las = 2, main = "", xlab = "");
title(main = "A. Expected Count", xlab = "Log-CPM");
abline(v = lcpm.cutoff, lty = 3);
for (i in 2:nsamples){
den = density(lcpm[, i])
lines(den$x, den$y, lwd = 2)
}
lcpm = cpm(x, log = TRUE);
plot(density(lcpm[, 1]), lwd = 2, ylim = c(0, 0.26), las = 2, main = "", xlab = "");
title(main = "B. Filtered Expected Count", xlab = "Log-CPM");
abline(v = lcpm.cutoff, lty = 3);
for (i in 2:nsamples){
den = density(lcpm[, i])
lines(den$x, den$y, lwd = 2)
}

```
Compute scaling factors to convert observed library sizes into effective library sizes.
```{r}
x = calcNormFactors(x, method = "upperquartile")
```
Generate design matrix.
```{r}
design = model.matrix(~0 + group)
```
Set up contrast for comparison.
```{r}
colnames(design) = gsub("group", "", colnames(design));
contr.matrix = makeContrasts(TCGAvsGTEX = TCGA - GTEX,
levels = colnames(design))
```
Transform RNA-Seq data for linear modeling.
```{r}
v = voom(x, design, plot = TRUE)
voomExpr = v$E
```
plot and see if there is a diference
```{r}
htree_norm2 <- hclust(dist(t(voomExpr)), method = "average") #can take some time
dend4 <- as.dendrogram(htree_norm2)
col_aa_red <- ifelse(grepl("GTEX", labels(dend4)), "red", "blue")
dend5 <- assign_values_to_leaves_edgePar(dend=dend4, value = col_aa_red, edgePar = "col") 
pdf(file="//wsl.localhost/Ubuntu-18.04/home/ieva/rprojects/TCGA-OV-data/figures/htree_no_pseudo_gtex_tcga_norm2_red.pdf", height=80, width=100) #issaugijimui didesniu formatu
plot(dend5) #dstant samples should be excluded #save portrait 20x66 inch pdf
dev.off()
```
Vienodai gavos su praeitu clusterinimu

From the downstream analysis for my intrest:
```{r}
vfit = lmFit(v, design)
vfit = contrasts.fit(vfit, contrasts = contr.matrix) #Returns the logFC between groups (TCGA vs. GTEx) via contrasts of the fitted linear models.
efit = eBayes(vfit)
summary(decideTests(efit))
tfit = treat(vfit, lfc = 0.58);
summary(decideTests(tfit)) #Examines the number of DEGs with the added condition of minimum log-FC of 0.58.
DEGsTreat = topTreat(tfit, n = Inf)
```
Idomumo delei idedu modeli i GDCtools tool
This is the function:
```{r}
counts <- counts_gtcga
#unfiltered
expr = DGEList(counts = counts)
expr = calcNormFactors(expr)
v_unfiltered <- voom(expr, design= model.matrix(~0 + group), plot = TRUE)$E

```
```{r}
#filtered
keepALL <- rowSums(cpm(expr) > 1) >= 0.5*ncol(counts)
        nGenes <- as.numeric(summary(keepALL)[2]) + 
            as.numeric(summary(keepALL)[3])
        nKeep <- summary(keepALL)[3]
        
        cat (paste('Total Number of genes: ', nGenes, '\n', sep=''))
        cat (paste('Number of genes for downstream analysis: ', nKeep, 
            '\n', sep=''))
        
exprALL <- expr[keepALL,,keep.lib.sizes = TRUE]
v_filtered <- voom(exprALL, design= model.matrix(~0 + group), plot = TRUE)$E

```
AR GDC tools +modelis filtered yra tas pats kaip is XENA pavyzdio?
```{r}
dim(v_filtered)
dim(voomExpr)
#dydziu tai ne, bet gal filtravimo standartai skiriasi
#how about values?

```

